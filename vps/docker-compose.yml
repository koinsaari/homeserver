services:
  ntfy:
    image: binwiederhier/ntfy:latest
    container_name: ntfy
    restart: unless-stopped
    command: serve
    env_file: .env
    user: "1000:1000"
    mem_limit: 256m
    security_opt:
      - no-new-privileges:true
    environment:
      NTFY_BASE_URL: "https://ntfy.${DOMAIN}"
      NTFY_LISTEN_HTTP: ":8082"
      NTFY_BEHIND_PROXY: "true"
      NTFY_AUTH_DEFAULT_ACCESS: "deny-all"
      NTFY_AUTH_FILE: "/var/lib/ntfy/auth.db"
      NTFY_ENABLE_LOGIN: true
    volumes:
      - ntfy_data:/var/lib/ntfy
      - ntfy_cache:/var/cache/ntfy
    networks:
      - proxy-net

  mollysocket:
    image: ghcr.io/mollyim/mollysocket:latest
    container_name: mollysocket
    restart: unless-stopped
    command: server
    working_dir: /data
    env_file: .env
    mem_limit: 256m
    security_opt:
      - no-new-privileges:true
    environment:
      MOLLY_DB: "/data/mollysocket.db"
      MOLLY_HOST: "0.0.0.0"
      MOLLY_PORT: "8091"
      MOLLY_URL: "https://molly.${DOMAIN}"
      MOLLY_VAPID_PRIVKEY: "${MOLLY_VAPID_PRIVKEY}"
      MOLLY_ALLOWED_ENDPOINTS: '["https://ntfy.${DOMAIN}"]'
      MOLLY_ALLOWED_UUIDS: '["*"]'
    volumes:
      - mollysocket_data:/data
    networks:
      - proxy-net

  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    mem_limit: 256m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      TZ: ${TZ:-UTC}
      DOMAIN: ${DOMAIN}
      X_AUTHELIA_CONFIG_FILTERS: 'template'
      AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE: '/secrets/jwt_secret'
      AUTHELIA_SESSION_SECRET_FILE: '/secrets/session_secret'
      AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE: '/secrets/storage_encryption_key'
    volumes:
      - ./authelia:/config:ro
      - ./authelia/secrets:/secrets:ro
      - authelia_data:/data
    networks:
      - proxy-net

  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    env_file: .env
    mem_limit: 256m
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - proxy-net

networks:
  proxy-net:
    external: true

volumes:
  ntfy_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/ntfy_data
  ntfy_cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/ntfy_cache
  mollysocket_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/mollysocket_data
  caddy_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/caddy_data
  caddy_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/caddy_config
  authelia_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/authelia_data